## Creates the semantic models and metrics needed for the initiative as described in https://www.notion.so/dataroots/Metrics-dae9c72b57544bc8ba85ae83efaa9a24
semantic_models:
  - name: fct_jaffleshop
    description: Model containing our jaffle shop data and metrics.
    defaults:                                
      agg_time_dimension: order_date
    model: ref('fct_jaffleshop')
    entities:
      - name: id
        type: primary
        expr: sk_id
      - name: customer
        type: foreign
        expr: customer_id
      - name: payment
        type: foreign
        expr: payment_id

    dimensions:
      - name: order_date
        expr: order_date
        type: time
        type_params:
          time_granularity: day
      - name: customer_id
        expr: customer_id
        type: categorical
      - name: payment_status
        expr: payment_status
        type: categorical

    measures:
      - name: average_payment_amount
        description: The average payment amount
        expr: amount
        agg: average
      - name: revenue
        description: The total revenue of the shop
        expr: amount
        agg: sum
      - name: payments
        description: The number of payments
        expr: payment_id
        agg: count_distinct

metrics:
  - name: average_payment_amount_per_customer
    label: average_payment_amount_per_customer
    description: Metrics n°3 - Average amount paid per customer.
    type: cumulative
    type_params:
      measure: average_payment_amount
  - name: total_revenue
    label: total_revenue
    description: Metrics n°4 - Total revenue generated by the shop.
    type: simple
    type_params:
      measure: revenue
  - name: percentage_of_successful_payments
    label: percentage_of_successful_payments
    description: Metrics n° 5 - Percentage of attempted transactions resulted in successful payments
    type: derived
    type_params:
      expr: (successful_payments / number_of_payments) * 100
      metrics:
        - name: number_of_payments
          alias: successful_payments
          filter: |
            {{ Dimension('id__payment_status') }} = 'success'
        - name: number_of_payments
  - name: number_of_payments
    label: number_of_payments
    description: Count the number of payments
    type: simple
    type_params:
      measure: payments